# 测试要求

本文档定义了shared_contracts库的测试要求和标准，确保代码质量和功能稳定性。

## 测试类型

shared_contracts库需要以下类型的测试：

### 1. 单元测试

- **范围**：测试各个组件的独立功能
- **位置**：`tests/`目录
- **命名约定**：`test_*.py`
- **要求**：
  - 每个模块至少需要一个测试文件
  - 公共API的覆盖率至少达到80%
  - 所有测试必须是独立的，不依赖于外部服务或状态
  - 使用mock对象代替外部依赖

### 2. 集成测试

- **范围**：测试组件之间的交互和工作流
- **位置**：`integration_tests/`目录
- **命名约定**：`test_*.py`
- **要求**：
  - 测试关键工作流和服务间交互
  - 使用模拟服务代替真实外部服务
  - 所有测试应该是独立的，不依赖于测试顺序

### 3. 代码风格测试

- **工具**：black, isort, flake8, mypy
- **执行**：通过pre-commit钩子和CI流程执行
- **要求**：
  - 所有代码必须通过风格检查
  - 严格遵循类型提示

## 测试环境

### 本地测试环境

- Python 3.10或更高版本
- 使用Poetry管理依赖
- 本地执行脚本：`scripts/run_tests.sh`

### CI测试环境

- GitHub Actions工作流
- 每次提交都必须通过所有测试
- 生成并上传覆盖率报告到Codecov

## 测试覆盖率要求

- **整体覆盖率**：至少80%
- **核心模块覆盖率**：至少90%
- **接口覆盖率**：100%
- **监控覆盖率**：至少70%
- **工具函数覆盖率**：至少80%

## 测试运行指南

### 运行所有测试

```bash
./scripts/run_tests.sh
```

### 仅运行单元测试

```bash
./scripts/run_tests.sh --type unit
```

### 仅运行集成测试

```bash
./scripts/run_tests.sh --type integration
```

### 运行特定模式的测试

```bash
./scripts/run_tests.sh --pattern "model"
```

### 不生成覆盖率报告

```bash
./scripts/run_tests.sh --coverage 0
```

## 测试数据

- 测试数据应存储在`tests/test_data/`目录中
- 数据文件应该使用JSON、YAML或纯文本格式
- 敏感数据必须使用模拟值

## 测试报告

- HTML覆盖率报告：`htmlcov/index.html`
- XML覆盖率报告：`coverage.xml`（用于CI集成）

## 测试维护

- 所有测试必须随代码变化而更新
- 定期重构测试以保持可维护性
- 测试失败必须在新代码合并前修复

## 特殊测试场景

### 错误处理测试

- 测试所有预期的错误场景
- 验证错误消息和状态

### 边界条件测试

- 测试边界输入值
- 测试空值、极值和无效输入

### 性能测试

- 在大量数据情况下验证关键操作性能
- 验证内存使用效率

### 并发测试

- 测试并发请求处理
- 验证线程安全性
