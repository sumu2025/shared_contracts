# CI/CD指南

本文档详细说明了shared_contracts仓库的CI/CD流程、配置和最佳实践。

## 目录

- [CI/CD流程概述](#cicd流程概述)
- [GitHub Actions工作流](#github-actions工作流)
- [本地验证](#本地验证)
- [代码风格自动修复](#代码风格自动修复)
- [监控与告警](#监控与告警)
- [常见CI/CD问题排查](#常见cicd问题排查)

## CI/CD流程概述

shared_contracts仓库的CI/CD流程分为以下几个阶段：

1. **验证（Validate）**：检查代码风格、依赖项和类型注解。
2. **测试（Test）**：运行单元测试和生成覆盖率报告。
3. **构建（Build）**：构建Python包。
4. **部署（Deploy）**：将包部署到目标环境（仅限主分支）。

### 触发条件

- **Push事件**：推送到`main`或`develop`分支时触发。
- **Pull Request事件**：创建或更新指向`main`或`develop`的PR时触发。
- **忽略路径**：对`*.md`文件和`docs/`目录的更改不会触发工作流。

## GitHub Actions工作流

所有CI/CD流程都由GitHub Actions自动化。以下是主要工作流及其功能：

### 主要CI工作流

文件：`.github/workflows/ci.yml`

包含以下作业：

1. **validate作业**：
   - 检出代码
   - 设置Python环境
   - 安装依赖
   - 进行依赖检查（包括Pydantic版本）
   - 执行代码风格检查（包括自动修复）
   - 执行类型检查

2. **test作业**：
   - 依赖validate作业完成
   - 运行单元测试
   - 生成覆盖率报告
   - 上传报告到Codecov

3. **build作业**：
   - 依赖test作业完成
   - 构建Python包
   - 上传构建产物

4. **deploy作业**：
   - 依赖build作业完成
   - 仅在主分支上触发
   - 下载构建产物
   - 将包部署到目标环境

## 本地验证

在提交代码前，应该运行本地验证脚本，确保代码符合项目标准：

```bash
./scripts/validate.sh
```

该脚本会执行以下检查：

1. 依赖项检查（包括Pydantic版本）
2. 代码风格检查（black、isort、flake8）
3. 类型检查（mypy）
4. 单元测试（pytest）
5. 覆盖率报告

## 代码风格自动修复

CI工作流和本地环境都支持代码风格自动修复：

### 本地自动修复

```bash
# 自动格式化代码
./scripts/auto_format.sh

# 固定特定问题
./scripts/fix_all_flake8.sh  # 修复所有flake8问题
./scripts/fix_long_lines.sh  # 修复过长行
./scripts/fix_bare_except.sh  # 修复裸异常
```

### CI中的自动修复

CI工作流配置了在检查失败时尝试自动修复代码风格问题，然后再次运行检查，这样可以减少因格式问题导致的CI失败。

## 监控与告警

我们使用LogFire服务监控CI/CD流程，跟踪构建、测试和部署状态。

### 监控配置

CI工作流会在执行过程中记录关键指标和事件：

- 构建开始和结束事件
- 每个构建步骤的状态和持续时间
- 测试结果和覆盖率
- 部署状态和版本信息

### 告警设置

在以下情况下会触发告警：

- CI工作流失败
- 测试覆盖率低于阈值（目前设置为80%）
- 部署失败

### 监控仪表板

LogFire仪表板提供了CI/CD流程的实时监控和历史数据分析：

- 构建成功率和平均持续时间
- 测试覆盖率趋势
- 最常见的失败原因
- 部署频率和成功率

## 常见CI/CD问题排查

### 1. 依赖版本冲突

**问题**：CI中的依赖安装或导入失败，特别是与Pydantic相关的问题。

**排查步骤**：
1. 检查CI日志中的依赖检查步骤输出
2. 确认Pydantic版本是否为2.x
3. 检查冲突的具体包和版本

**解决方案**：
- 更新pyproject.toml中的依赖版本
- 添加或更新dependency_overrides
- 运行`poetry update`更新依赖锁定文件

### 2. 代码风格检查失败

**问题**：black、isort或flake8检查失败。

**排查步骤**：
1. 检查CI日志中的具体错误消息
2. 确认是否有自动修复尝试
3. 查看具体的问题文件和行号

**解决方案**：
- 本地运行自动修复：`./scripts/auto_format.sh`
- 手动解决复杂问题
- 对于团队共享的格式设置，更新项目配置文件

### 3. 类型检查错误

**问题**：mypy报告类型错误。

**排查步骤**：
1. 检查CI日志中的类型错误详情
2. 确认问题是否与第三方库类型存根相关
3. 查看相关变量的实际类型

**解决方案**：
- 添加或更正类型注解
- 安装缺失的类型存根：`poetry add --dev types-<package>`
- 在必要时使用类型注释抑制：`# type: ignore`

### 4. 测试失败

**问题**：单元测试或集成测试失败。

**排查步骤**：
1. 检查CI日志中的测试失败详情
2. 确认失败的测试名称和断言
3. 检查相关代码的最近更改

**解决方案**：
- 修复代码中的Bug
- 更新过时的测试
- 使用`pytest -v`本地调试失败的测试

### 5. 构建失败

**问题**：Python包构建失败。

**排查步骤**：
1. 检查CI日志中的构建错误详情
2. 验证pyproject.toml配置
3. 检查包含的文件和目录

**解决方案**：
- 更新构建配置
- 修复包结构问题
- 本地测试构建：`poetry build`

### 6. 部署失败

**问题**：部署到目标环境失败。

**排查步骤**：
1. 检查CI日志中的部署错误详情
2. 验证部署凭证和权限
3. 检查目标环境状态

**解决方案**：
- 更新部署凭证
- 修复环境配置问题
- 暂时跳过部署，手动执行
