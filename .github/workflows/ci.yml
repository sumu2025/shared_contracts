name: Enhanced CI

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å‘¨ä¸€è¿è¡Œå…¨é¢æµ‹è¯•
    - cron: '0 0 * * 1'

env:
  LOGFIRE_WRITE_TOKEN: ${{ secrets.LOGFIRE_WRITE_TOKEN }}
  PYTHON_VERSION: '3.10'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install --with dev
        
    - name: ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
      run: |
        chmod +x scripts/*.sh
        chmod +x scripts/*.py
        ls -la scripts/
        
    - name: ä¾èµ–æ£€æŸ¥
      run: |
        poetry check
        # æ£€æŸ¥ pydantic ç‰ˆæœ¬
        python -c "import pydantic; print(f'Pydantic version: {pydantic.__version__}'); assert int(pydantic.__version__.split('.')[0]) >= 2, 'Pydantic version must be >= 2.0'"
        
    - name: è‡ªåŠ¨ä¿®å¤ä»£ç é£æ ¼é—®é¢˜
      if: github.event_name == 'pull_request'
      run: |
        # è‡ªåŠ¨ä¿®å¤æ–‡æ¡£å­—ç¬¦ä¸²é—®é¢˜
        poetry run python scripts/fix_docstrings_auto.py
        
        # æ ¼å¼åŒ–ä»£ç 
        poetry run black .
        
        # ä¿®å¤å¯¼å…¥æ’åº
        poetry run isort .
        
        # ä¿®å¤é•¿è¡Œé—®é¢˜
        poetry run python scripts/fix_remaining_long_lines.py
        
        # ä¸ºå‰©ä½™é—®é¢˜æ·»åŠ noqaæ ‡è®°
        poetry run python scripts/add_noqa.py
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
        if [[ -n $(git status -s) ]]; then
          git config --global user.name "CI Bot"
          git config --global user.email "ci-bot@example.com"
          git add .
          git commit -m "ğŸ¤– è‡ªåŠ¨ä¿®å¤ä»£ç é£æ ¼é—®é¢˜"
          git push
        fi
        
    - name: ä»£ç é£æ ¼æ£€æŸ¥
      run: |
        # æ£€æŸ¥æ ¼å¼
        poetry run black . --check --line-length=88
        
        # æ£€æŸ¥å¯¼å…¥æ’åº
        poetry run isort . --check --profile black
        
        # æ£€æŸ¥ä»£ç é£æ ¼
        poetry run flake8 . --max-line-length=88 --extend-ignore=E203,D400,D107
        
    - name: ç±»å‹æ£€æŸ¥
      run: |
        poetry run mypy --namespace-packages --explicit-package-bases --exclude "examples/" .
    
    # æ–°å¢: å®‰å…¨æ‰«æ    
    - name: è¿è¡Œå®‰å…¨æ‰«æ
      run: |
        # å®‰è£…å®‰å…¨æ‰«æå·¥å…·
        pip install bandit safety
        
        # è¿è¡ŒBanditæ‰«æ
        bandit -r . -x ./tests,./examples
        
        # æ£€æŸ¥ä¾èµ–å®‰å…¨é—®é¢˜
        safety check -r requirements.txt || true  # ä¸è¦å› ä¸ºå®‰å…¨è­¦å‘Šè€Œå¤±è´¥æ„å»º
        
  test:
    runs-on: ubuntu-latest
    needs: validate
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install
        
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        poetry run pytest -xvs tests/
        
    - name: æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      run: |
        poetry run pytest --cov=agentforge_contracts tests/ --cov-report=xml
    
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        
    # æ–°å¢: è¿è¡Œå®‰å…¨æµ‹è¯•
    - name: è¿è¡Œå®‰å…¨æµ‹è¯•
      run: |
        poetry run pytest -xvs tests/security/
    
    # æ–°å¢: è¿è¡Œé›†æˆæµ‹è¯•
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      if: github.event_name == 'schedule' || github.ref == 'refs/heads/main'
      run: |
        poetry run pytest -xvs integration_tests/
        
  performance:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry install
        
    # æ–°å¢: è¿è¡Œæ€§èƒ½æµ‹è¯•
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        # å®šä¹‰æ€§èƒ½åŸºå‡†
        export PERFORMANCE_THRESHOLD_MS=2.0
        
        # è¿è¡Œæ€§èƒ½æµ‹è¯•
        poetry run pytest -xvs tests/performance/
        
    # æ–°å¢: å‘é€æ€§èƒ½æ•°æ®åˆ°LogFire
    - name: å‘é€æ€§èƒ½æŒ‡æ ‡åˆ°LogFire
      if: env.LOGFIRE_WRITE_TOKEN != ''
      run: |
        # è¿è¡Œæ€§èƒ½æµ‹è¯•å¹¶æ”¶é›†ç»“æœ
        export LOGFIRE_ENABLED=true
        poetry run python tests/performance/test_performance.py
    
  build:
    runs-on: ubuntu-latest
    needs: [test, performance]
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install poetry
        poetry config virtualenvs.create false
        poetry install --with dev
        
    - name: æ„å»ºåŒ…
      run: |
        poetry build
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: dist
        path: dist/
        retention-days: 5
    
    # æ–°å¢: è¿è¡Œæ–‡æ¡£ç”Ÿæˆ
    - name: ç”Ÿæˆæ–‡æ¡£
      run: |
        pip install mkdocs mkdocs-material
        mkdocs build
        
    - name: ä¸Šä¼ æ–‡æ¡£
      uses: actions/upload-artifact@v3
      with:
        name: docs
        path: site/
        retention-days: 5

  # ä»…åœ¨ä¸»åˆ†æ”¯ä¸Šè§¦å‘éƒ¨ç½²æµç¨‹
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: dist
        path: dist
        
    - name: åˆ—å‡ºæ„å»ºäº§ç‰©
      run: ls -la dist/
      
    # åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ å‘å¸ƒåˆ°PyPIæˆ–ç§æœ‰ä»“åº“çš„æ­¥éª¤
    # ç°åœ¨ä»…æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
    - name: æ¨¡æ‹Ÿéƒ¨ç½²
      run: |
        echo "éƒ¨ç½²shared_contractsåŒ…åˆ°æµ‹è¯•ç¯å¢ƒ"
        echo "éƒ¨ç½²ç‰ˆæœ¬: $(cat dist/*.tar.gz | cut -d'-' -f2 | cut -d'.' -f1-3)"
        echo "éƒ¨ç½²æ—¶é—´: $(date)"
    
    # æ–°å¢: éƒ¨ç½²æ–‡æ¡£
    - name: ä¸‹è½½æ–‡æ¡£
      uses: actions/download-artifact@v3
      with:
        name: docs
        path: site
        
    - name: éƒ¨ç½²æ–‡æ¡£
      run: |
        echo "éƒ¨ç½²æ–‡æ¡£åˆ°æµ‹è¯•ç¯å¢ƒ"
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡æ¡£éƒ¨ç½²é€»è¾‘
        
    # æ–°å¢: å‘é€éƒ¨ç½²é€šçŸ¥
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      if: env.LOGFIRE_WRITE_TOKEN != ''
      run: |
        export VERSION=$(cat dist/*.tar.gz | cut -d'-' -f2 | cut -d'.' -f1-3)
        
        # ä½¿ç”¨Pythonè„šæœ¬å‘é€éƒ¨ç½²äº‹ä»¶
        python -c "
        import requests, os, json, datetime
        
        # æ„å»ºäº‹ä»¶æ•°æ®
        event = {
            'timestamp': datetime.datetime.now(datetime.UTC).isoformat(),
            'service': 'shared_contracts',
            'version': os.environ.get('VERSION', 'unknown'),
            'environment': 'production',
            'status': 'success',
            'commit': os.environ.get('GITHUB_SHA', 'unknown'),
            'repository': os.environ.get('GITHUB_REPOSITORY', 'unknown'),
            'actor': os.environ.get('GITHUB_ACTOR', 'unknown'),
        }
        
        # å‘é€åˆ°LogFire API
        headers = {
            'Authorization': f'Bearer {os.environ.get(\"LOGFIRE_WRITE_TOKEN\")}',
            'Content-Type': 'application/json',
        }
        
        try:
            response = requests.post(
                'https://api.logfire.sh/logs',
                headers=headers,
                json={'logs': [event]},
            )
            print(f'Deployment notification sent: {response.status_code}')
        except Exception as e:
            print(f'Error sending deployment notification: {e}')
        "
